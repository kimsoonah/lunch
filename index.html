import { useState, useEffect } from 'react';
import { Utensils, Plus, Trash2, Edit2, Check, X, RefreshCw } from 'lucide-react';

export default function RestaurantPicker() {
  const foodIcons = ['üçú', 'üçï', 'üç±', 'üåÆ', 'üçõ', 'ü•ò', 'üçî', 'üç£', 'ü•ó', 'üç≤', 'üçù', 'ü•ô', 'üçñ', 'ü•©', 'üçó', 'üå≠', 'ü•™', 'üç§', 'ü•ü', 'üç≥', 'ü•ì', 'üßÜ', 'üçø', 'ü•Æ'];

  // GitHub ÏÑ§Ï†ï - Ïó¨Í∏∞Î•º ÏàòÏ†ïÌïòÏÑ∏Ïöî!
  const GITHUB_CONFIG = {
    username: 'kimsoonah',  // Î≥∏Ïù∏Ïùò GitHub ÏÇ¨Ïö©ÏûêÎ™Ö
    repo: 'lunch',      // Ï†ÄÏû•ÏÜå Ïù¥Î¶Ñ
    token: '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', // Personal Access Token
    file: 'lunch.json'
  };

  const defaultRestaurants = [
    { icon: 'ü•©', name: 'Ïú°ÎØ∏' },
    { icon: 'üç≤', name: 'ÍπÄÏπòÏ∞åÍ∞ú' },
    { icon: 'üç≤', name: 'Î∂ÄÎåÄÏ∞åÍ∞ú' },
    { icon: 'üçú', name: 'ÏπºÍµ≠Ïàò' },
    { icon: 'üç±', name: 'ÎèàÍπåÏä§' },
    { icon: 'ü•ò', name: 'Í∞àÎπÑÌÉï' },
    { icon: 'üçù', name: 'ÏßúÏû•Î©¥' },
    { icon: 'üçó', name: 'Îã≠Í≥∞ÌÉï' },
    { icon: 'ü•ü', name: 'ÏàòÏ†úÎπÑ' },
    { icon: 'üçî', name: 'ÌñÑÎ≤ÑÍ±∞' }
  ];

  const [restaurants, setRestaurants] = useState(defaultRestaurants);
  const [selected, setSelected] = useState(null);
  const [spinning, setSpinning] = useState(false);
  const [editMode, setEditMode] = useState(false);
  const [editingIndex, setEditingIndex] = useState(null);
  const [editValue, setEditValue] = useState('');
  const [editIcon, setEditIcon] = useState('');
  const [newRestaurant, setNewRestaurant] = useState('');
  const [newIcon, setNewIcon] = useState('üçΩÔ∏è');
  const [showIconPicker, setShowIconPicker] = useState(false);
  const [showEditIconPicker, setShowEditIconPicker] = useState(false);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [fileSha, setFileSha] = useState('');

  // GitHubÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Í∏∞
  const loadFromGitHub = async () => {
    setLoading(true);
    try {
      const response = await fetch(
        `https://api.github.com/repos/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.file}`,
        {
          headers: {
            'Authorization': `token ${GITHUB_CONFIG.token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        }
      );

      if (response.ok) {
        const data = await response.json();
        setFileSha(data.sha);
        const content = JSON.parse(atob(data.content));
        setRestaurants(content);
      } else {
        console.log('ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. Í∏∞Î≥∏ Îç∞Ïù¥ÌÑ∞Î•º ÏÇ¨Ïö©Ìï©ÎãàÎã§.');
        setRestaurants(defaultRestaurants);
      }
    } catch (error) {
      console.error('GitHubÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
      setRestaurants(defaultRestaurants);
    } finally {
      setLoading(false);
    }
  };

  // GitHubÏóê Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•ÌïòÍ∏∞
  const saveToGitHub = async (newRestaurants) => {
    setSaving(true);
    try {
      const content = btoa(unescape(encodeURIComponent(JSON.stringify(newRestaurants, null, 2))));
      
      const response = await fetch(
        `https://api.github.com/repos/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.file}`,
        {
          method: 'PUT',
          headers: {
            'Authorization': `token ${GITHUB_CONFIG.token}`,
            'Accept': 'application/vnd.github.v3+json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: 'ÏãùÎãπ Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏',
            content: content,
            sha: fileSha
          })
        }
      );

      if (response.ok) {
        const data = await response.json();
        setFileSha(data.content.sha);
      } else {
        alert('Ï†ÄÏû• Ïã§Ìå®. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
      }
    } catch (error) {
      console.error('GitHubÏóê Ï†ÄÏû• Ïã§Ìå®:', error);
      alert('Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
    } finally {
      setSaving(false);
    }
  };

  // Ï¥àÍ∏∞ Î°úÎìú
  useEffect(() => {
    loadFromGitHub();
  }, []);

  const updateRestaurants = (newRestaurants) => {
    setRestaurants(newRestaurants);
    saveToGitHub(newRestaurants);
  };

  const pickRandom = () => {
    if (restaurants.length === 0) {
      alert('ÏãùÎãπÏùÑ Î®ºÏ†Ä Ï∂îÍ∞ÄÌï¥Ï£ºÏÑ∏Ïöî!');
      return;
    }

    setSpinning(true);
    setSelected(null);

    let count = 0;
    const interval = setInterval(() => {
      const randomRestaurant = restaurants[Math.floor(Math.random() * restaurants.length)];
      setSelected(randomRestaurant);
      count++;
      
      if (count > 15) {
        clearInterval(interval);
        const finalPick = restaurants[Math.floor(Math.random() * restaurants.length)];
        setSelected(finalPick);
        setSpinning(false);
      }
    }, 100);
  };

  const addRestaurant = () => {
    if (newRestaurant.trim()) {
      updateRestaurants([...restaurants, { icon: newIcon, name: newRestaurant.trim() }]);
      setNewRestaurant('');
      setNewIcon('üçΩÔ∏è');
      setShowIconPicker(false);
    }
  };

  const deleteRestaurant = (index) => {
    updateRestaurants(restaurants.filter((_, i) => i !== index));
    if (selected === restaurants[index]) {
      setSelected(null);
    }
  };

  const startEdit = (index) => {
    setEditingIndex(index);
    setEditValue(restaurants[index].name);
    setEditIcon(restaurants[index].icon);
  };

  const saveEdit = () => {
    if (editValue.trim()) {
      const newRestaurants = [...restaurants];
      newRestaurants[editingIndex] = { icon: editIcon, name: editValue.trim() };
      updateRestaurants(newRestaurants);
    }
    setEditingIndex(null);
    setEditValue('');
    setEditIcon('');
    setShowEditIconPicker(false);
  };

  const cancelEdit = () => {
    setEditingIndex(null);
    setEditValue('');
    setEditIcon('');
    setShowEditIconPicker(false);
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-orange-100 to-red-100 flex items-center justify-center">
        <div className="text-center">
          <RefreshCw className="w-12 h-12 text-orange-500 animate-spin mx-auto mb-4" />
          <p className="text-gray-600 text-lg">Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Îäî Ï§ë...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-orange-100 to-red-100 flex items-center justify-center p-4">
      <div className="bg-white rounded-3xl shadow-2xl p-8 max-w-2xl w-full">
        <div className="text-center mb-8">
          <div className="flex justify-center mb-4">
            <Utensils className="w-16 h-16 text-orange-500" />
          </div>
          <h1 className="text-3xl font-bold text-gray-800 mb-2">
            Ï†êÏã¨ ÏãùÎãπ Ï∂îÏ≤ú
          </h1>
          <p className="text-gray-600">
            Ïò§ÎäòÏùÄ Ïñ¥ÎîîÏÑú Î®πÏùÑÍπåÏöî?
          </p>
          {saving && (
            <p className="text-sm text-blue-600 mt-2">üíæ Ï†ÄÏû• Ï§ë...</p>
          )}
        </div>

        <div className="mb-8">
          <div className="bg-gradient-to-r from-orange-50 to-red-50 rounded-2xl p-8 min-h-[120px] flex items-center justify-center border-2 border-orange-200">
            {selected ? (
              <div className={`text-center ${spinning ? 'animate-pulse' : 'animate-bounce'}`}>
                <div className="text-5xl mb-2">{selected.icon}</div>
                <div className="text-2xl font-bold text-gray-800">{selected.name}</div>
              </div>
            ) : (
              <div className="text-gray-400 text-lg">
                Î≤ÑÌäºÏùÑ ÎàåÎü¨Î≥¥ÏÑ∏Ïöî!
              </div>
            )}
          </div>
        </div>

        <button
          onClick={pickRandom}
          disabled={spinning}
          className={`w-full py-4 rounded-xl font-bold text-lg transition-all mb-6 ${
            spinning
              ? 'bg-gray-400 cursor-not-allowed'
              : 'bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 shadow-lg hover:shadow-xl'
          } text-white`}
        >
          {spinning ? 'ÏÑ†ÌÉù Ï§ë...' : 'üé≤ ÎûúÎç§ ÏÑ†ÌÉù!'}
        </button>

        {editMode && (
          <div className="mb-6 p-4 bg-blue-50 rounded-xl border-2 border-blue-200">
            <p className="text-sm font-semibold text-blue-800 mb-3">ÏÉà ÏãùÎãπ Ï∂îÍ∞Ä</p>
            <div className="flex gap-2 mb-2">
              <div className="relative">
                <button
                  onClick={() => setShowIconPicker(!showIconPicker)}
                  className="w-12 h-12 text-2xl bg-white border border-blue-300 rounded-lg hover:bg-blue-50 transition-colors"
                >
                  {newIcon}
                </button>
                {showIconPicker && (
                  <div className="absolute top-14 left-0 z-10 bg-white border-2 border-blue-300 rounded-lg shadow-xl p-3 grid grid-cols-6 gap-2 w-64">
                    {foodIcons.map((icon, index) => (
                      <button
                        key={index}
                        onClick={() => {
                          setNewIcon(icon);
                          setShowIconPicker(false);
                        }}
                        className="text-2xl hover:bg-blue-100 rounded p-1 transition-colors"
                      >
                        {icon}
                      </button>
                    ))}
                  </div>
                )}
              </div>
              <input
                type="text"
                value={newRestaurant}
                onChange={(e) => setNewRestaurant(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && addRestaurant()}
                placeholder="ÏãùÎãπ Ïù¥Î¶Ñ ÏûÖÎ†•"
                className="flex-1 px-4 py-2 border border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
              <button
                onClick={addRestaurant}
                disabled={saving}
                className="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors flex items-center gap-2 disabled:bg-gray-400"
              >
                <Plus className="w-5 h-5" />
                Ï∂îÍ∞Ä
              </button>
            </div>
          </div>
        )}

        <div className="p-4 bg-gray-50 rounded-xl">
          <div className="flex items-center justify-between mb-3">
            <p className="text-sm text-gray-600 font-semibold">
              ÏãùÎãπ Î™©Î°ù ({restaurants.length}Í∞ú)
            </p>
            <div className="flex gap-2">
              <button
                onClick={loadFromGitHub}
                disabled={loading}
                className="px-3 py-2 rounded-lg font-semibold text-sm transition-all bg-green-500 hover:bg-green-600 text-white shadow hover:shadow-md disabled:bg-gray-400"
                title="ÏµúÏã† Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Í∏∞"
              >
                <RefreshCw className={`w-4 h-4 ${loading ? 'animate-spin' : ''}`} />
              </button>
              <button
                onClick={() => setEditMode(!editMode)}
                className={`px-4 py-2 rounded-lg font-semibold text-sm transition-all ${
                  editMode
                    ? 'bg-gray-500 hover:bg-gray-600'
                    : 'bg-blue-500 hover:bg-blue-600'
                } text-white shadow hover:shadow-md`}
              >
                {editMode ? 'ÏôÑÎ£å' : 'Ìé∏Ïßë'}
              </button>
            </div>
          </div>
          <div className="grid grid-cols-5 gap-3">
            {restaurants.map((restaurant, index) => (
              <div
                key={index}
                className="relative group"
              >
                {editingIndex === index ? (
                  <div className="bg-white p-3 rounded-lg border-2 border-blue-500 shadow-lg">
                    <div className="relative mb-2">
                      <button
                        onClick={() => setShowEditIconPicker(!showEditIconPicker)}
                        className="w-full text-3xl py-2 bg-gray-50 border border-gray-300 rounded hover:bg-gray-100 transition-colors"
                      >
                        {editIcon}
                      </button>
                      {showEditIconPicker && (
                        <div className="absolute top-12 left-0 z-20 bg-white border-2 border-blue-300 rounded-lg shadow-xl p-3 grid grid-cols-6 gap-2 w-64">
                          {foodIcons.map((icon, idx) => (
                            <button
                              key={idx}
                              onClick={() => {
                                setEditIcon(icon);
                                setShowEditIconPicker(false);
                              }}
                              className="text-2xl hover:bg-blue-100 rounded p-1 transition-colors"
                            >
                              {icon}
                            </button>
                          ))}
                        </div>
                      )}
                    </div>
                    <input
                      type="text"
                      value={editValue}
                      onChange={(e) => setEditValue(e.target.value)}
                      onKeyPress={(e) => e.key === 'Enter' && saveEdit()}
                      className="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 mb-2"
                      autoFocus
                    />
                    <div className="flex gap-1 justify-center">
                      <button
                        onClick={saveEdit}
                        disabled={saving}
                        className="p-1.5 text-green-600 hover:bg-green-50 rounded transition-colors disabled:text-gray-400"
                      >
                        <Check className="w-4 h-4" />
                      </button>
                      <button
                        onClick={cancelEdit}
                        className="p-1.5 text-red-600 hover:bg-red-50 rounded transition-colors"
                      >
                        <X className="w-4 h-4" />
                      </button>
                    </div>
                  </div>
                ) : (
                  <div className="bg-white p-4 rounded-lg border border-gray-200 hover:shadow-md transition-all h-full flex flex-col items-center justify-center text-center min-h-[100px]">
                    <span className="text-3xl mb-2">{restaurant.icon}</span>
                    <span className="text-sm text-gray-700 break-words w-full">{restaurant.name}</span>
                    {editMode && (
                      <div className="absolute top-1 right-1 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button
                          onClick={() => startEdit(index)}
                          className="p-1.5 bg-blue-500 text-white hover:bg-blue-600 rounded shadow-md transition-colors"
                        >
                          <Edit2 className="w-3 h-3" />
                        </button>
                        <button
                          onClick={() => deleteRestaurant(index)}
                          disabled={saving}
                          className="p-1.5 bg-red-500 text-white hover:bg-red-600 rounded shadow-md transition-colors disabled:bg-gray-400"
                        >
                          <Trash2 className="w-3 h-3" />
                        </button>
                      </div>
                    )}
                  </div>
                )}
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>
  );
}